---
layout: post
title: python代码性能测试
categories: python
tags: python
author: nsf
---

* content
{:toc}
本次测试测试的是运行速度，内存可自行分析，测试包含字符串拼接



# 1.字符串拼接

> 测试代码

```
import timeit
no = 1000000
def test_add():
    a, k = '', 'k'
    for i in range(no):
        a = a + k
def test_append():
    a, k = [], 'k'
    for i in range(no):
        a.append(k)
    ''.join(a)
def test_f():
    a, k = '', 'k'
    for i in range(no):
        a = f'{a}{k}'
start = timeit.default_timer()
test_add()
elapsed = (timeit.default_timer() - start)
print(elapsed)
```

以下测试为简单列表展示，实际测试中比如'kkkk'这种字段也有测试，但是因为加入对实验结果没影响所以没有加入。

**测试test_add()**

| 替换k | 替换a = a + k | 输出                                   |
| ----- | ------------- | -------------------------------------- |
|       |               | 0.15099272374363473                    |
| 'kk'  |               | 0.4066574444154053                     |
|       | a + k + k     | 453.186699538277(和循环次数呈指数上升) |

**测试test_append()**

| 替换k | 替换a.append(k) | 输出                |
| ----- | --------------- | ------------------- |
|       |                 | 0.14970760136569225 |
| 'kk'  |                 | 0.15229560256203242 |
|       | a + k + k       | 0.28787823299002363 |

**测试test_f()**

| 替换k | 替换a = f'{a}{k}' | 输出               |
| ----- | ----------------- | ------------------ |
|       |                   | 30.091696478065526 |
| 'kk'  |                   | 没必要了           |
|       | a + k + k         | 没必要了           |

> 由上可以看出，拼接次数很多建议使用List().append(),下面测试少量循环循环三个方法的性能

| 函数          | 替换n | 替换k | 替换表达式                                  | 输出                   |
| ------------- | ----- | ----- | ------------------------------------------- | ---------------------- |
| test_add()    | 100   |       |                                             | 9.433108991805958e-06  |
| test_append() | 100   |       |                                             | 1.3872219105596997e-05 |
| test_f()      | 100   |       |                                             | 1.5536885398268637e-05 |
| test_add()    | 10000 |       |                                             | 0.0015134591044206323  |
| test_append() | 10000 |       |                                             | 0.0011394640773337373  |
| test_f()      | 10000 |       |                                             | 0.006813201691522909   |
| test_add()    | 100   |       | a + k + k + k                               | 2.996399326808951e-05  |
| test_append() | 100   |       | a.append(k)     a.append(k)     a.append(k) | 3.329332585343279e-05  |
| test_f()      | 100   |       | a = f'{a}{k}{k}{k}'                         | 2.6079771918522353e-05 |

> 总结如下
>
> 1.循环次数（>1w）或者被拼接字符串长度较长时，建议使用List().append()
>
> 2.'+'作为官方应该做了简化，但是只适合于拼接次数少或者被拼接字符串长度短的情况
>
> 3.f’‘用法是格式化的方式，从测试来看不太好比较和'+'的效率，个人建议在循环次数不太多，但是被拼接字符较长时使用

> ps:还有python不同版本的一些字符串格式化方式，和f''(3.6版本)差不多,如'%s %s' % ('hello', 'world')，和'{}{}'.format('hello', 'world')

事实上，在拼接短的字面值时，由于CPython中的 `常数折叠` （constant folding）功能，这些字面值会被转换成更短的形式，例如'a'+'b'+'c' 被转换成'abc'，'hello'+'world'也会被转换成'hello world'。这种转换是在编译期完成的，而到了运行期时就不会再发生任何拼接操作，因此会加快整体计算的速度。

常数折叠优化有一个限度，它要求拼接结果的长度不超过20。所以，当拼接的最终字符串长度不超过20时，+号操作符的方式，会比后面提到的join等方式快得多，这与+号的使用次数无关。